# Setup Guide

Complete setup instructions for the Convex React Template with authentication, email verification, and OTP system.

## Table of Contents

1. [Prerequisites](#prerequisites)
2. [Quick Start](#quick-start)
3. [Convex Setup](#convex-setup)
4. [Email Configuration (Resend)](#email-configuration-resend)
5. [Environment Variables](#environment-variables)
6. [Running the Project](#running-the-project)
7. [Admin Account](#admin-account)
8. [Testing Email Features](#testing-email-features)
9. [Production Deployment](#production-deployment)
10. [Troubleshooting](#troubleshooting)

## Prerequisites

Before you begin, ensure you have the following installed:

- **Node.js** (v18 or higher)
- **npm** or **pnpm** or **yarn**
- **Git** (for version control)

## Quick Start

Get up and running in 3 minutes:

```bash
# 1. Install dependencies
npm install

# 2. Set up Convex
npx convex dev

# 3. Start the development server (in a new terminal)
npm run dev
```

Your app will be available at `http://localhost:5173`

## Convex Setup

### 1. Create a Convex Account

1. Go to [https://dashboard.convex.dev](https://dashboard.convex.dev)
2. Sign up or log in with GitHub
3. Create a new project (or use existing)

### 2. Initialize Convex

```bash
npx convex dev
```

This will:
- Create a `.env.local` file with your `VITE_CONVEX_URL`
- Deploy your backend functions to Convex
- Set up real-time sync
- Create database tables from schema

### 3. Verify Setup

After running `npx convex dev`, you should see:

```
✔ Deployed successfully!
┌ Dashboard: https://dashboard.convex.dev/t/your-team/your-project
└ Deployment: https://your-deployment.convex.cloud
```

Your `.env.local` should now contain:

```bash
VITE_CONVEX_URL=https://your-deployment.convex.cloud
```

### 4. Explore the Dashboard

Visit your Convex Dashboard to:
- View database tables (users, emailLogs, otpCodes)
- Run queries and mutations
- Monitor function logs
- Set up scheduled cron jobs

## Email Configuration (Resend)

Email features (verification, password reset) require Resend configuration.

### 1. Create a Resend Account

1. Go to [https://resend.com](https://resend.com)
2. Sign up for a free account
3. Verify your email address

### 2. Get Your API Key

1. Go to **API Keys** in the Resend dashboard
2. Click **Create API Key**
3. Give it a name (e.g., "Development" or "Production")
4. Copy the API key (starts with `re_`)

### 3. Configure Sending Domain

**Option A: Use Resend's Test Domain (Development)**

For testing, you can use `onboarding@resend.dev`:
- No DNS setup required
- Can only send to your verified email
- Perfect for development

**Option B: Use Your Own Domain (Production)**

1. Go to **Domains** in Resend dashboard
2. Click **Add Domain**
3. Enter your domain (e.g., `yourdomain.com`)
4. Add the provided DNS records to your domain:
   - SPF record
   - DKIM records
   - DMARC record (optional but recommended)
5. Wait for DNS propagation (up to 48 hours)
6. Verify domain in Resend dashboard

### 4. Add Resend Config to Convex

```bash
# Navigate to your Convex dashboard
# Go to Settings > Environment Variables
# Add the following:

RESEND_API_KEY=re_your_api_key_here
RESEND_FROM_EMAIL=noreply@yourdomain.com
# Or for testing:
RESEND_FROM_EMAIL=onboarding@resend.dev
```

**Important:** Environment variables must be set in the Convex Dashboard, not `.env.local`. This keeps your API key secure.

### 5. Verify Email Setup

After adding environment variables:

1. Restart your Convex dev server: `npx convex dev`
2. Try signing up for a new account
3. Click "Verify Email" in the banner
4. Check your email for the verification code

## Environment Variables

### Required Variables

**`.env.local` (Auto-generated by Convex):**
```bash
VITE_CONVEX_URL=https://your-deployment.convex.cloud
```

**Convex Dashboard (Settings > Environment Variables):**
```bash
# Required for email features
RESEND_API_KEY=re_xxxxxxxxxxxxx
RESEND_FROM_EMAIL=noreply@yourdomain.com

# Optional - Application Info
VITE_APP_NAME=Your App Name
VITE_APP_URL=http://localhost:5173
VITE_SUPPORT_EMAIL=support@yourapp.com

# Optional - OTP Configuration
OTP_EXPIRY_MINUTES=15
MAX_OTP_ATTEMPTS=5
MAX_OTP_REQUESTS=3

# Optional - Rate Limiting
MAX_EMAIL_PER_HOUR=5
MAX_LOGIN_ATTEMPTS=5

# Optional - Feature Flags
ENABLE_EMAIL_VERIFICATION=true
ENABLE_2FA=false
SEND_WELCOME_EMAIL=false
```

### Feature Flags Explained

- `ENABLE_EMAIL_VERIFICATION` - Require email verification for new users
- `ENABLE_2FA` - Enable two-factor authentication (coming soon)
- `SEND_WELCOME_EMAIL` - Send welcome email on signup

### Using Environment Variables

**Backend (Convex functions):**
```typescript
const apiKey = process.env.RESEND_API_KEY;
```

**Frontend (React components):**
```typescript
const appName = import.meta.env.VITE_APP_NAME;
```

## Running the Project

### Development Mode

**Terminal 1: Convex Backend**
```bash
npx convex dev
```

**Terminal 2: React Frontend**
```bash
npm run dev
```

The app will be available at:
- **Frontend**: `http://localhost:5173`
- **Convex Dashboard**: Check terminal output for link

### Production Build

```bash
# Build frontend
npm run build

# Preview production build
npm run preview
```

### Package Scripts

```json
{
  "dev": "vite",                    // Start Vite dev server
  "build": "tsc && vite build",     // Build for production
  "preview": "vite preview",        // Preview production build
  "convex:dev": "npx convex dev",   // Start Convex dev server
  "convex:deploy": "npx convex deploy" // Deploy to production
}
```

## Admin Account

The template includes a default admin account for testing.

### 1. Sign Up with Admin Email

1. Open your app at `http://localhost:5173`
2. Click "Sign up" (not "Sign in")
3. Use these credentials:
   ```
   Email: admin@example.com
   Password: admin123
   ```
4. Click "Sign Up"

### 2. Admin Role Assignment

The admin role is **automatically assigned** during signup based on email. Check `convex/simpleAuth.ts`:

```typescript
role: args.email === "admin@example.com" ? "admin" : "user"
```

### 3. Verify Admin Access

After signing up:
1. You should see the **AdminDashboard** instead of UserDashboard
2. The header should show your admin name with a sign-out button

### 4. Change Admin Password (Recommended)

For security, change the admin password:

1. Sign in as admin
2. Go to Settings (if available)
3. Or manually update via Convex Dashboard:
   - Open `users` table
   - Find `admin@example.com`
   - Click **Edit**
   - Update `passwordHash` with new bcrypt hash

### 5. Add More Admins

To make other users admins:

**Option A: Update in Convex Dashboard**
1. Go to Convex Dashboard > Data > `users` table
2. Find the user
3. Edit their document
4. Add/update field: `role` = `"admin"`
5. Save

**Option B: Create a mutation**
```typescript
// convex/admin.ts
export const promoteToAdmin = mutation({
  args: { userId: v.id("users") },
  handler: async (ctx, args) => {
    // Add auth check here
    await ctx.db.patch(args.userId, { role: "admin" });
  },
});
```

### 6. Customize Admin Email

To use a different admin email:

1. Edit `convex/simpleAuth.ts`
2. Change this line:
```typescript
role: args.email === "your-email@example.com" ? "admin" : "user"
```

## Testing Email Features

### 1. Email Verification Flow

**Test the complete email verification:**

1. Sign up with a new account (not admin@example.com)
2. You'll see a yellow verification banner
3. Click "Verify Now" in the banner
4. Check your email for the 6-digit code
5. Enter the code on the verification page
6. You should see "Email verified successfully!"

**Test rate limiting:**
- Request verification code more than 3 times in 15 minutes
- Should see: "Too many requests. Please try again in 15 minutes."

**Test expiration:**
- Wait 15+ minutes after requesting code
- Try to use the old code
- Should see: "Verification code has expired"

### 2. Password Reset Flow

**Test the complete password reset:**

1. Sign out if logged in
2. Click "Forgot Password?" on sign-in form
3. Enter your email address
4. Check email for 6-digit reset code
5. Enter code and new password
6. Sign in with new password

**Test with non-existent email:**
- Enter email that doesn't exist
- Should see: "No account found with this email"

### 3. Manual Email Testing

Use the Convex Dashboard to send test emails:

1. Go to Functions tab
2. Find `emails:sendVerificationEmail`
3. Click "Run"
4. Enter test parameters:
```json
{
  "email": "your@email.com",
  "name": "Test User",
  "code": "123456"
}
```
5. Check your email

### 4. Check Email Logs

Monitor email delivery:

1. Go to Convex Dashboard > Data > `emailLogs`
2. View all sent/failed emails
3. Check error messages for failed sends

## Production Deployment

### 1. Deploy Backend (Convex)

```bash
npx convex deploy --prod
```

This will:
- Deploy all functions to production
- Create production database
- Generate production `VITE_CONVEX_URL`

### 2. Update Environment Variables

1. Go to Convex Dashboard
2. Switch to **Production** environment
3. Add all environment variables (same as dev):
   - `RESEND_API_KEY`
   - `RESEND_FROM_EMAIL`
   - etc.

### 3. Update Frontend Config

Update `.env.production`:
```bash
VITE_CONVEX_URL=https://your-prod-deployment.convex.cloud
VITE_APP_URL=https://yourapp.com
```

### 4. Deploy Frontend

Deploy to your hosting provider:

**Vercel:**
```bash
npm install -g vercel
vercel
```

**Netlify:**
```bash
npm install -g netlify-cli
netlify deploy --prod
```

**Other Providers:**
- Build: `npm run build`
- Deploy `dist/` directory
- Set environment variables in hosting dashboard

### 5. Configure Production Domain

1. Update `RESEND_FROM_EMAIL` to use your domain
2. Verify domain in Resend dashboard
3. Add DNS records
4. Update `VITE_APP_URL` to production URL

### 6. Test Production

1. Sign up with new account
2. Verify email verification works
3. Test password reset
4. Check email delivery
5. Monitor Convex Dashboard for errors

## Troubleshooting

### Common Issues

**Q: "Module not found" errors**

A: Install dependencies:
```bash
rm -rf node_modules package-lock.json
npm install
```

---

**Q: Convex functions not deploying**

A: Check your Convex dev server:
```bash
# Restart Convex
npx convex dev

# Check for TypeScript errors in convex/ directory
npx tsc --noEmit -p convex/tsconfig.json
```

---

**Q: Emails not sending**

A: Verify Resend configuration:
1. Check `RESEND_API_KEY` in Convex Dashboard
2. Verify `RESEND_FROM_EMAIL` domain
3. Check `emailLogs` table for error messages
4. For testing, use `onboarding@resend.dev`

---

**Q: "Too many requests" error immediately**

A: Clear old OTP codes:
1. Go to Convex Dashboard > Data > `otpCodes`
2. Delete all documents
3. Or wait 15 minutes for rate limit to reset

---

**Q: Verification code doesn't work**

A: Check OTP table:
1. Go to Data > `otpCodes`
2. Find your email
3. Check `expiresAt` timestamp
4. Verify `used` is `false`
5. Ensure code matches exactly

---

**Q: Sign in fails after signup**

A: Possible causes:
1. Using "Sign In" instead of "Sign Up" initially
2. Wrong password (passwords are case-sensitive)
3. Check Convex logs for error details

---

**Q: Admin role not working**

A: Verify role assignment:
1. Check `users` table in Convex Dashboard
2. Find your user
3. Verify `role` field is `"admin"` (string)
4. Sign out and sign in again

---

**Q: Frontend can't connect to Convex**

A: Check configuration:
1. Verify `.env.local` has `VITE_CONVEX_URL`
2. Ensure Convex dev server is running
3. Check browser console for errors
4. Try restarting both servers

---

**Q: Password hash error during signin**

A: bcrypt compatibility issue:
```bash
npm rebuild bcryptjs
# or
npm install bcryptjs --force
```

---

**Q: Cron jobs not running**

A: Check Convex Dashboard:
1. Go to Functions > Cron Jobs
2. Verify jobs are scheduled
3. Check last run time
4. View execution logs

---

### Debug Mode

Enable debug logging:

```typescript
// In your code
console.log("Debug info:", data);
```

View logs:
1. Convex Dashboard > Functions > Logs
2. Browser DevTools Console
3. Network tab for API calls

### Getting Help

- **Documentation**: [https://docs.convex.dev](https://docs.convex.dev)
- **Resend Docs**: [https://resend.com/docs](https://resend.com/docs)
- **Discord**: Convex Discord community
- **GitHub Issues**: Report bugs in template repository

### Additional Resources

- [AUTH_GUIDE.md](./AUTH_GUIDE.md) - Authentication flow details
- [API.md](./API.md) - Complete API reference
- [TROUBLESHOOTING.md](./TROUBLESHOOTING.md) - Detailed troubleshooting guide
- [.env.example](./.env.example) - Example environment variables

## Next Steps

After completing setup:

1. ✅ Customize the UI/branding
2. ✅ Update admin email in `convex/simpleAuth.ts`
3. ✅ Configure your own domain in Resend
4. ✅ Add more user roles if needed
5. ✅ Implement additional features
6. ✅ Set up monitoring and analytics
7. ✅ Configure production deployment
8. ✅ Add tests for critical flows

**Congratulations!** Your Convex app with authentication and email is ready to go. 🎉
